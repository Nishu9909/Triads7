name: CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update-ads:
    runs-on: ubuntu-latest

    env:
      CF_API_TOKEN: ${{ secrets.API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.ACCOUNT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Download blocklists
        run: |
          mkdir lists
          curl -s "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/multi.txt" -o lists/1.txt
          curl -s "https://raw.githubusercontent.com/SJvV/OIS/main/oisd_big.txt" -o lists/2.txt
          curl -s "https://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/MobileFilter/sections/adservers.txt" -o lists/3.txt
          curl -s "https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Browse%20Config/IndianList.txt" -o lists/4.txt

      - name: Build small domain list
        run: |
          cat lists/*.txt \
            | sed 's/[ 
].*$//' \
            | grep -E '^[a-zA-Z0-9.-]+$' \
            | sort -u \
            | head -n 1000 > all-domains.txt
          echo "First 20 domains:"
          head -n 20 all-domains.txt

      - name: Create JSON body
        run: |
          echo '{' > body.json
          echo '  "name": "ads-block",' >> body.json
          echo '  "description": "Test adblock list from GitHub",' >> body.json
          echo '  "type": "DOMAIN",' >> body.json
          echo '  "items": [' >> body.json

          first=1
          while read -r domain; do
            [ -z "$domain" ] && continue
            if [ $first -eq 0 ]; then
              echo ',' >> body.json
            fi
            first=0
            printf '    {"value":"%s","type":"hostname"}' "$domain" >> body.json
          done < all-domains.txt

          echo '' >> body.json
          echo '  ]' >> body.json
          echo '}' >> body.json

          echo "Request body (truncated):"
          head -c 500 body.json || true

      - name: Upload to Cloudflare Gateway list
        run: |
          curl -v -X PUT \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/gateway/lists/ads-block" \
            --data @body.json